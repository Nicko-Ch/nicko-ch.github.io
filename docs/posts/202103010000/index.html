<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Go高级编程 - Benchmark | &gt; $ cd /home</title>
<meta name="keywords" content="Go, Golang" />
<meta name="description" content="基础用法  benchmark和普通单元测试用例一样，文件命名都为 _test.go 函数名以 Benchmark 开头，参数是 b *testing.B。 对比普通的单元测试用例： 函数名以 Test 开头，参数是 t *testing.T。  运行用例 基础用例  运行当前 package 内的用例：go test example 或 go test . 运行子 package 内的用例： go test example/&lt;package name&gt; 或 go test ./&lt;package name&gt; 如果想递归测试当前目录下的所有的 package：go test ./... 或 go test example/...。  $ go test -bench . goos: darwin goarch: amd64 pkg: example BenchmarkFib-8 200 5865240 ns/op PASS ok example 1.782s  正则匹配，例：只运行以 Fib 结尾的benchmark用例  $ go test -bench=&#39;Fib$&#39; .">
<meta name="author" content="">
<link rel="canonical" href="https://nicko-ch.github.io/posts/202103010000/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.0459a4ebf56f381ae411e97a494635ba7ce9db741ff9a2cfbf7e12366bf1e73d.css" integrity="sha256-BFmk6/VvOBrkEel6SUY1unzp23Qf&#43;aLPv34SNmvx5z0=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.6f62d19b78590241c3e007a10f91f45f95ce2528ca8f3e33c542e95f8ed5691f.js" integrity="sha256-b2LRm3hZAkHD4AehD5H0X5XOJSjKjz4zxULpX47VaR8="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://nicko-ch.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://nicko-ch.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://nicko-ch.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://nicko-ch.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://nicko-ch.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.88.0" />
<meta property="og:title" content="Go高级编程 - Benchmark" />
<meta property="og:description" content="基础用法  benchmark和普通单元测试用例一样，文件命名都为 _test.go 函数名以 Benchmark 开头，参数是 b *testing.B。 对比普通的单元测试用例： 函数名以 Test 开头，参数是 t *testing.T。  运行用例 基础用例  运行当前 package 内的用例：go test example 或 go test . 运行子 package 内的用例： go test example/&lt;package name&gt; 或 go test ./&lt;package name&gt; 如果想递归测试当前目录下的所有的 package：go test ./... 或 go test example/...。  $ go test -bench . goos: darwin goarch: amd64 pkg: example BenchmarkFib-8 200 5865240 ns/op PASS ok example 1.782s  正则匹配，例：只运行以 Fib 结尾的benchmark用例  $ go test -bench=&#39;Fib$&#39; ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://nicko-ch.github.io/posts/202103010000/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-03-01T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2021-03-01T00:00:00&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Go高级编程 - Benchmark"/>
<meta name="twitter:description" content="基础用法  benchmark和普通单元测试用例一样，文件命名都为 _test.go 函数名以 Benchmark 开头，参数是 b *testing.B。 对比普通的单元测试用例： 函数名以 Test 开头，参数是 t *testing.T。  运行用例 基础用例  运行当前 package 内的用例：go test example 或 go test . 运行子 package 内的用例： go test example/&lt;package name&gt; 或 go test ./&lt;package name&gt; 如果想递归测试当前目录下的所有的 package：go test ./... 或 go test example/...。  $ go test -bench . goos: darwin goarch: amd64 pkg: example BenchmarkFib-8 200 5865240 ns/op PASS ok example 1.782s  正则匹配，例：只运行以 Fib 结尾的benchmark用例  $ go test -bench=&#39;Fib$&#39; ."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://nicko-ch.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Go高级编程 - Benchmark",
      "item": "https://nicko-ch.github.io/posts/202103010000/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Go高级编程 - Benchmark",
  "name": "Go高级编程 - Benchmark",
  "description": "基础用法  benchmark和普通单元测试用例一样，文件命名都为 _test.go 函数名以 Benchmark 开头，参数是 b *testing.B。 对比普通的单元测试用例： 函数名以 Test 开头，参数是 t *testing.T。  运行用例 基础用例  运行当前 package 内的用例：go test example 或 go test . 运行子 package 内的用例： go test example/\u0026lt;package name\u0026gt; 或 go test ./\u0026lt;package name\u0026gt; 如果想递归测试当前目录下的所有的 package：go test ./... 或 go test example/...。  $ go test -bench . goos: darwin goarch: amd64 pkg: example BenchmarkFib-8 200 5865240 ns/op PASS ok example 1.782s  正则匹配，例：只运行以 Fib 结尾的benchmark用例  $ go test -bench=\u0026#39;Fib$\u0026#39; .",
  "keywords": [
    "Go", "Golang"
  ],
  "articleBody": "基础用法  benchmark和普通单元测试用例一样，文件命名都为 _test.go 函数名以 Benchmark 开头，参数是 b *testing.B。 对比普通的单元测试用例： 函数名以 Test 开头，参数是 t *testing.T。  运行用例 基础用例  运行当前 package 内的用例：go test example 或 go test . 运行子 package 内的用例： go test example/ 或 go test ./ 如果想递归测试当前目录下的所有的 package：go test ./... 或 go test example/...。  $ go test -bench . goos: darwin goarch: amd64 pkg: example BenchmarkFib-8 200 5865240 ns/op PASS ok example 1.782s  正则匹配，例：只运行以 Fib 结尾的benchmark用例  $ go test -bench='Fib$' . goos: darwin goarch: amd64 pkg: example BenchmarkFib-8 202 5980669 ns/op PASS ok example 1.813s  BenchmarkFib-8 中的 -8 即 GOMAXPROCS，默认等于 CPU 核数。可以通过 -cpu 参数改变 GOMAXPROCS，-cpu 支持传入一个列表作为参数，例如：  $ go test -bench='Fib$' -cpu=2,4 . goos: darwin goarch: amd64 pkg: example BenchmarkFib-2 206 5774888 ns/op BenchmarkFib-4 205 5799426 ns/op PASS ok example 3.563s 在这个例子中，改变 CPU 的核数对结果几乎没有影响，因为这个 Fib 的调用是串行的。\n202 和 5980669 ns/op 表示用例执行了 202 次，每次花费约 0.006s。总耗时比 1s 略多。\n 对于性能测试来说，提升测试准确度的一个重要手段就是增加测试的次数。我们可以使用 -benchtime 和 -count 两个参数达到这个目的。  提升准确度 对于性能测试来说，提升测试准确度的一个重要手段就是增加测试的次数。我们可以使用 -benchtime 和 -count 两个参数达到这个目的。\nbenchmark 的默认时间是 1s，那么我们可以使用 -benchtime 指定为 5s。例如：\n$ go test -bench='Fib$' -benchtime=5s .\rgoos: darwin\rgoarch: amd64\rpkg: example\rBenchmarkFib-8 1033 5769818 ns/op\rPASS\rok example 6.554s\r 实际执行的时间是 6.5s，比 benchtime 的 5s 要长，测试用例编译、执行、销毁等是需要时间的。\n 将 -benchtime 设置为 5s，用例执行次数也变成了原来的 5倍，每次函数调用时间仍为 0.6s，几乎没有变化。\n benchtime 的值除了是时间外，还可以是具体的次数。例如，执行 30 次可以用 benchtime=30x：  $ go test -bench='Fib$' -benchtime=50x .\rgoos: darwin\rgoarch: amd64\rpkg: example\rBenchmarkFib-8 50 6121066 ns/op\rPASS\rok example 0.319s\r调用 50 次 fib(30)，仅花费了 0.319s。\n count 参数可以用来设置 benchmark 的轮数。例如，进行 3 轮 benchmark。  $ go test -bench='Fib$' -benchtime=5s -count=3 .\rgoos: darwin\rgoarch: amd64\rpkg: example\rBenchmarkFib-8 975 5946624 ns/op\rBenchmarkFib-8 1023 5820582 ns/op\rBenchmarkFib-8 961 6096816 ns/op\rPASS\rok example 19.463s\r内存分配情况  benchmem 参数可以度量内存分配的次数。内存分配次数也性能也是息息相关的，例如不合理的切片容量，将导致内存重新分配，带来不必要的开销。  在下面的例子中，generateWithCap 和 generate 的作用是一致的，生成一组长度为 n 的随机序列。唯一的不同在于，generateWithCap 创建切片时，将切片的容量(capacity)设置为 n，这样切片就会一次性申请 n 个整数所需的内存。\n// generate_test.go package main import ( \"math/rand\" \"testing\" \"time\" ) func generateWithCap(n int) []int { rand.Seed(time.Now().UnixNano()) nums := make([]int, 0, n) for i := 0; i n; i++ { nums = append(nums, rand.Int()) } return nums } func generate(n int) []int { rand.Seed(time.Now().UnixNano()) nums := make([]int, 0) for i := 0; i n; i++ { nums = append(nums, rand.Int()) } return nums } func BenchmarkGenerateWithCap(b *testing.B) { for n := 0; n b.N; n++ { generateWithCap(1000000) } } func BenchmarkGenerate(b *testing.B) { for n := 0; n b.N; n++ { generate(1000000) } } 运行该用例的结果是：\ngo test -bench='Generate' .\rgoos: darwin\rgoarch: amd64\rpkg: example\rBenchmarkGenerateWithCap-8 44 24294582 ns/op\rBenchmarkGenerate-8 34 30342763 ns/op\rPASS\rok example 2.171s\r可以看到生成 100w 个数字的随机序列，GenerateWithCap 的耗时比 Generate 少 20%。\n我们可以使用 -benchmem 参数看到内存分配的情况：\ngoos: darwin\rgoarch: amd64\rpkg: example\rBenchmarkGenerateWithCap-8 43 24335658 ns/op 8003641 B/op 1 allocs/op\rBenchmarkGenerate-8 33 30403687 ns/op 45188395 B/op 40 allocs/op\rPASS\rok example 2.121s\rGenerate 分配的内存是 GenerateWithCap 的 6 倍，设置了切片容量，内存只分配一次，而不设置切片容量，内存分配了 40 次。\n测试不同的输入 不同的函数复杂度不同，O(1)，O(n)，O(n^2) 等，利用 benchmark 验证复杂度一个简单的方式，是构造不同的输入。对刚才的 benchmark 稍作改造，便能够达到目的。\n// generate_test.go package main import ( \"math/rand\" \"testing\" \"time\" ) func generate(n int) []int { rand.Seed(time.Now().UnixNano()) nums := make([]int, 0) for i := 0; i n; i++ { nums = append(nums, rand.Int()) } return nums } func benchmarkGenerate(i int, b *testing.B) { for n := 0; n b.N; n++ { generate(i) } } func BenchmarkGenerate1000(b *testing.B) { benchmarkGenerate(1000, b) } func BenchmarkGenerate10000(b *testing.B) { benchmarkGenerate(10000, b) } func BenchmarkGenerate100000(b *testing.B) { benchmarkGenerate(100000, b) } func BenchmarkGenerate1000000(b *testing.B) { benchmarkGenerate(1000000, b) } 这里，我们实现一个辅助函数 benchmarkGenerate 允许传入参数 i，并构造了 4 个不同输入的 benchmark 用例。运行结果如下：\n$ go test -bench . goos: darwin\rgoarch: amd64\rpkg: example\rBenchmarkGenerate1000-8 34048 34643 ns/op\rBenchmarkGenerate10000-8 4070 295642 ns/op\rBenchmarkGenerate100000-8 403 3230415 ns/op\rBenchmarkGenerate1000000-8 39 32083701 ns/op\rPASS\rok example 6.597s\r通过测试结果可以发现，输入变为原来的 10 倍，函数每次调用的时长也差不多是原来的 10 倍，这说明复杂度是线性的。\nResetTimer 如果在 benchmark 开始前，需要一些准备工作，如果准备工作比较耗时，则需要将这部分代码的耗时忽略掉。比如下面的例子：\nfunc BenchmarkFib(b *testing.B) { time.Sleep(time.Second * 3) // 模拟耗时准备任务 \tfor n := 0; n b.N; n++ { fib(30) // run fib(30) b.N times \t} } 运行结果是：\n$ go test -bench='Fib$' -benchtime=50x .\rgoos: darwin\rgoarch: amd64\rpkg: example\rBenchmarkFib-8 50 65912552 ns/op\rPASS\rok example 6.319s\r50次调用，每次调用约 0.66s，是之前的 0.06s 的 11 倍。究其原因，受到了耗时准备任务的干扰。我们需要用 ResetTimer 屏蔽掉：\nfunc BenchmarkFib(b *testing.B) { time.Sleep(time.Second * 3) // 模拟耗时准备任务 \tb.ResetTimer() // 重置定时器 \tfor n := 0; n b.N; n++ { fib(30) // run fib(30) b.N times \t} } $ go test -bench='Fib$' -benchtime=50x .\rgoos: darwin\rgoarch: amd64\rpkg: example\rBenchmarkFib-8 50 6187485 ns/op\rPASS\rok example 6.330s\rStopTimer \u0026 StartTimer 还有一种情况，每次函数调用前后需要一些准备工作和清理工作，我们可以使用 StopTimer 暂停计时以及使用 StartTimer 开始计时。\n例如，如果测试一个冒泡函数的性能，每次调用冒泡函数前，需要随机生成一个数字序列，这是非常耗时的操作，这种场景下，就需要使用 StopTimer 和 StartTimer 避免将这部分时间计算在内。\n例如：\n// sort_test.go package main import ( \"math/rand\" \"testing\" \"time\" ) func generateWithCap(n int) []int { rand.Seed(time.Now().UnixNano()) nums := make([]int, 0, n) for i := 0; i n; i++ { nums = append(nums, rand.Int()) } return nums } func bubbleSort(nums []int) { for i := 0; i nums); i++ { for j := 1; j nums)-i; j++ { if nums[j] nums[j-1] { nums[j], nums[j-1] = nums[j-1], nums[j] } } } } func BenchmarkBubbleSort(b *testing.B) { for n := 0; n b.N; n++ { b.StopTimer() nums := generateWithCap(10000) b.StartTimer() bubbleSort(nums) } } 执行该用例，每次排序耗时约 0.1s。\n$ go test -bench='Sort$' .\rgoos: darwin\rgoarch: amd64\rpkg: example\rBenchmarkBubbleSort-8 9 113280509 ns/op\rPASS\rok example 1.146s\r",
  "wordCount" : "800",
  "inLanguage": "en",
  "datePublished": "2021-03-01T00:00:00Z",
  "dateModified": "2021-03-01T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://nicko-ch.github.io/posts/202103010000/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "\u003e $ cd /home",
    "logo": {
      "@type": "ImageObject",
      "url": "https://nicko-ch.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://nicko-ch.github.io/" accesskey="h" title="&gt; $ cd /home (Alt + H)">&gt; $ cd /home</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://nicko-ch.github.io/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://nicko-ch.github.io/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="https://nicko-ch.github.io/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://nicko-ch.github.io/posts/" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="https://nicko-ch.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://nicko-ch.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://nicko-ch.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://nicko-ch.github.io/posts/">Posts</a></div>
    <h1 class="post-title">
      Go高级编程 - Benchmark
    </h1>
    <div class="post-meta">March 1, 2021&nbsp;·&nbsp;4 min
</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <div class="details">Table of Contents</div>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e5%9f%ba%e7%a1%80%e7%94%a8%e6%b3%95" aria-label="基础用法">基础用法</a></li>
                <li>
                    <a href="#%e8%bf%90%e8%a1%8c%e7%94%a8%e4%be%8b" aria-label="运行用例">运行用例</a><ul>
                        
                <li>
                    <a href="#%e5%9f%ba%e7%a1%80%e7%94%a8%e4%be%8b" aria-label="基础用例">基础用例</a></li>
                <li>
                    <a href="#%e6%8f%90%e5%8d%87%e5%87%86%e7%a1%ae%e5%ba%a6" aria-label="提升准确度"><strong>提升准确度</strong></a></li>
                <li>
                    <a href="#%e5%86%85%e5%ad%98%e5%88%86%e9%85%8d%e6%83%85%e5%86%b5" aria-label="内存分配情况"><strong>内存分配情况</strong></a></li>
                <li>
                    <a href="#%e6%b5%8b%e8%af%95%e4%b8%8d%e5%90%8c%e7%9a%84%e8%be%93%e5%85%a5" aria-label="测试不同的输入"><strong>测试不同的输入</strong></a></li>
                <li>
                    <a href="#resettimer" aria-label="ResetTimer"><strong>ResetTimer</strong></a></li>
                <li>
                    <a href="#stoptimer--starttimer" aria-label="StopTimer &amp;amp; StartTimer"><strong>StopTimer &amp; StartTimer</strong></a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="基础用法">基础用法<a hidden class="anchor" aria-hidden="true" href="#基础用法">#</a></h2>
<ul>
<li>benchmark和普通单元测试用例一样，文件命名都为 <code>_test.go</code></li>
<li>函数名以 <code>Benchmark</code> 开头，参数是 <code>b *testing.B</code>。
对比普通的单元测试用例：
函数名以 <code>Test</code> 开头，参数是 <code>t *testing.T</code>。</li>
</ul>
<h2 id="运行用例">运行用例<a hidden class="anchor" aria-hidden="true" href="#运行用例">#</a></h2>
<h3 id="基础用例">基础用例<a hidden class="anchor" aria-hidden="true" href="#基础用例">#</a></h3>
<ul>
<li>运行当前 package 内的用例：<code>go test example</code> 或 <code>go test .</code></li>
<li>运行子 package 内的用例： <code>go test example/&lt;package name&gt;</code> 或 <code>go test ./&lt;package name&gt;</code></li>
<li>如果想递归测试当前目录下的所有的 package：<code>go test ./...</code> 或 <code>go test example/...</code>。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">test</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">bench</span> .
<span style="color:#a6e22e">goos</span>: <span style="color:#a6e22e">darwin</span>
<span style="color:#a6e22e">goarch</span>: <span style="color:#a6e22e">amd64</span>
<span style="color:#a6e22e">pkg</span>: <span style="color:#a6e22e">example</span>
<span style="color:#a6e22e">BenchmarkFib</span><span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>               <span style="color:#ae81ff">200</span>           <span style="color:#ae81ff">5865240</span> <span style="color:#a6e22e">ns</span><span style="color:#f92672">/</span><span style="color:#a6e22e">op</span>
<span style="color:#a6e22e">PASS</span>
<span style="color:#a6e22e">ok</span>      <span style="color:#a6e22e">example</span> <span style="color:#ae81ff">1.782</span><span style="color:#a6e22e">s</span>
</code></pre></div><ul>
<li>正则匹配，例：只运行以 <code>Fib</code> 结尾的benchmark用例</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">test</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">bench</span>=<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Fib</span><span style="color:#960050;background-color:#1e0010">$&#39;</span> .
<span style="color:#a6e22e">goos</span>: <span style="color:#a6e22e">darwin</span>
<span style="color:#a6e22e">goarch</span>: <span style="color:#a6e22e">amd64</span>
<span style="color:#a6e22e">pkg</span>: <span style="color:#a6e22e">example</span>
<span style="color:#a6e22e">BenchmarkFib</span><span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>               <span style="color:#ae81ff">202</span>           <span style="color:#ae81ff">5980669</span> <span style="color:#a6e22e">ns</span><span style="color:#f92672">/</span><span style="color:#a6e22e">op</span>
<span style="color:#a6e22e">PASS</span>
<span style="color:#a6e22e">ok</span>      <span style="color:#a6e22e">example</span> <span style="color:#ae81ff">1.813</span><span style="color:#a6e22e">s</span>
</code></pre></div><ul>
<li>BenchmarkFib-8 中的 <code>-8</code> 即 <code>GOMAXPROCS</code>，默认等于 CPU 核数。可以通过 <code>-cpu</code> 参数改变 <code>GOMAXPROCS</code>，<code>-cpu</code> 支持传入一个列表作为参数，例如：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">test</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">bench</span>=<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Fib</span><span style="color:#960050;background-color:#1e0010">$&#39;</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">cpu</span>=<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">4</span> .
<span style="color:#a6e22e">goos</span>: <span style="color:#a6e22e">darwin</span>
<span style="color:#a6e22e">goarch</span>: <span style="color:#a6e22e">amd64</span>
<span style="color:#a6e22e">pkg</span>: <span style="color:#a6e22e">example</span>
<span style="color:#a6e22e">BenchmarkFib</span><span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>               <span style="color:#ae81ff">206</span>           <span style="color:#ae81ff">5774888</span> <span style="color:#a6e22e">ns</span><span style="color:#f92672">/</span><span style="color:#a6e22e">op</span>
<span style="color:#a6e22e">BenchmarkFib</span><span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>               <span style="color:#ae81ff">205</span>           <span style="color:#ae81ff">5799426</span> <span style="color:#a6e22e">ns</span><span style="color:#f92672">/</span><span style="color:#a6e22e">op</span>
<span style="color:#a6e22e">PASS</span>
<span style="color:#a6e22e">ok</span>      <span style="color:#a6e22e">example</span> <span style="color:#ae81ff">3.563</span><span style="color:#a6e22e">s</span>
</code></pre></div><p>在这个例子中，改变 CPU 的核数对结果几乎没有影响，因为这个 Fib 的调用是串行的。</p>
<p><code>202</code> 和 <code>5980669 ns/op</code> 表示用例执行了 202 次，每次花费约 0.006s。总耗时比 1s 略多。</p>
<ul>
<li>对于性能测试来说，提升测试准确度的一个重要手段就是增加测试的次数。我们可以使用 -benchtime 和 -count 两个参数达到这个目的。</li>
</ul>
<h3 id="提升准确度"><strong>提升准确度</strong><a hidden class="anchor" aria-hidden="true" href="#提升准确度">#</a></h3>
<p>对于性能测试来说，提升测试准确度的一个重要手段就是增加测试的次数。我们可以使用 <code>-benchtime</code> 和 <code>-count</code> 两个参数达到这个目的。</p>
<p>benchmark 的默认时间是 1s，那么我们可以使用 <code>-benchtime</code> 指定为 5s。例如：</p>
<pre tabindex="0"><code>$ go test -bench='Fib$' -benchtime=5s .
goos: darwin
goarch: amd64
pkg: example
BenchmarkFib-8              1033           5769818 ns/op
PASS
ok      example 6.554s

</code></pre><blockquote>
<p>实际执行的时间是 6.5s，比 benchtime 的 5s 要长，测试用例编译、执行、销毁等是需要时间的。</p>
</blockquote>
<p>将 <code>-benchtime</code> 设置为 5s，用例执行次数也变成了原来的 5倍，每次函数调用时间仍为 0.6s，几乎没有变化。</p>
<ul>
<li><code>benchtime</code> 的值除了是时间外，还可以是具体的次数。例如，执行 30 次可以用 <code>benchtime=30x</code>：</li>
</ul>
<pre tabindex="0"><code>$ go test -bench='Fib$' -benchtime=50x .
goos: darwin
goarch: amd64
pkg: example
BenchmarkFib-8                50           6121066 ns/op
PASS
ok      example 0.319s

</code></pre><p>调用 50 次 <code>fib(30)</code>，仅花费了 0.319s。</p>
<ul>
<li><code>count</code> 参数可以用来设置 benchmark 的轮数。例如，进行 3 轮 benchmark。</li>
</ul>
<pre tabindex="0"><code>$ go test -bench='Fib$' -benchtime=5s -count=3 .
goos: darwin
goarch: amd64
pkg: example
BenchmarkFib-8               975           5946624 ns/op
BenchmarkFib-8              1023           5820582 ns/op
BenchmarkFib-8               961           6096816 ns/op
PASS
ok      example 19.463s
</code></pre><h3 id="内存分配情况"><strong>内存分配情况</strong><a hidden class="anchor" aria-hidden="true" href="#内存分配情况">#</a></h3>
<ul>
<li><code>benchmem</code> 参数可以度量内存分配的次数。内存分配次数也性能也是息息相关的，例如不合理的切片容量，将导致内存重新分配，带来不必要的开销。</li>
</ul>
<p>在下面的例子中，<code>generateWithCap</code> 和 <code>generate</code> 的作用是一致的，生成一组长度为 n 的随机序列。唯一的不同在于，<code>generateWithCap</code> 创建切片时，将切片的容量(capacity)设置为 n，这样切片就会一次性申请 n 个整数所需的内存。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// generate_test.go
</span><span style="color:#75715e"></span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;math/rand&#34;</span>
	<span style="color:#e6db74">&#34;testing&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">generateWithCap</span>(<span style="color:#a6e22e">n</span> <span style="color:#66d9ef">int</span>) []<span style="color:#66d9ef">int</span> {
	<span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Seed</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">UnixNano</span>())
	<span style="color:#a6e22e">nums</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">int</span>, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">n</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">n</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">nums</span> = append(<span style="color:#a6e22e">nums</span>, <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Int</span>())
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">nums</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">generate</span>(<span style="color:#a6e22e">n</span> <span style="color:#66d9ef">int</span>) []<span style="color:#66d9ef">int</span> {
	<span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Seed</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">UnixNano</span>())
	<span style="color:#a6e22e">nums</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">int</span>, <span style="color:#ae81ff">0</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">n</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">nums</span> = append(<span style="color:#a6e22e">nums</span>, <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Int</span>())
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">nums</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">BenchmarkGenerateWithCap</span>(<span style="color:#a6e22e">b</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">B</span>) {
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">n</span> &lt; <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">N</span>; <span style="color:#a6e22e">n</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">generateWithCap</span>(<span style="color:#ae81ff">1000000</span>)
	}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">BenchmarkGenerate</span>(<span style="color:#a6e22e">b</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">B</span>) {
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">n</span> &lt; <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">N</span>; <span style="color:#a6e22e">n</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">generate</span>(<span style="color:#ae81ff">1000000</span>)
	}
}
</code></pre></div><p>运行该用例的结果是：</p>
<pre tabindex="0"><code>go test -bench='Generate' .
goos: darwin
goarch: amd64
pkg: example
BenchmarkGenerateWithCap-8            44          24294582 ns/op
BenchmarkGenerate-8                   34          30342763 ns/op
PASS
ok      example 2.171s
</code></pre><p>可以看到生成 100w 个数字的随机序列，<code>GenerateWithCap</code> 的耗时比 <code>Generate</code> 少 20%。</p>
<p>我们可以使用 <code>-benchmem</code> 参数看到内存分配的情况：</p>
<pre tabindex="0"><code>goos: darwin
goarch: amd64
pkg: example
BenchmarkGenerateWithCap-8  43  24335658 ns/op  8003641 B/op    1 allocs/op
BenchmarkGenerate-8         33  30403687 ns/op  45188395 B/op  40 allocs/op
PASS
ok      example 2.121s
</code></pre><p><code>Generate</code> 分配的内存是 <code>GenerateWithCap</code> 的 6 倍，设置了切片容量，内存只分配一次，而不设置切片容量，内存分配了 40 次。</p>
<h3 id="测试不同的输入"><strong>测试不同的输入</strong><a hidden class="anchor" aria-hidden="true" href="#测试不同的输入">#</a></h3>
<p>不同的函数复杂度不同，O(1)，O(n)，O(n^2) 等，利用 benchmark 验证复杂度一个简单的方式，是构造不同的输入。对刚才的 benchmark 稍作改造，便能够达到目的。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// generate_test.go
</span><span style="color:#75715e"></span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;math/rand&#34;</span>
	<span style="color:#e6db74">&#34;testing&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">generate</span>(<span style="color:#a6e22e">n</span> <span style="color:#66d9ef">int</span>) []<span style="color:#66d9ef">int</span> {
	<span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Seed</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">UnixNano</span>())
	<span style="color:#a6e22e">nums</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">int</span>, <span style="color:#ae81ff">0</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">n</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">nums</span> = append(<span style="color:#a6e22e">nums</span>, <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Int</span>())
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">nums</span>
}
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">benchmarkGenerate</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">b</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">B</span>) {
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">n</span> &lt; <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">N</span>; <span style="color:#a6e22e">n</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">generate</span>(<span style="color:#a6e22e">i</span>)
	}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">BenchmarkGenerate1000</span>(<span style="color:#a6e22e">b</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">B</span>)    { <span style="color:#a6e22e">benchmarkGenerate</span>(<span style="color:#ae81ff">1000</span>, <span style="color:#a6e22e">b</span>) }
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">BenchmarkGenerate10000</span>(<span style="color:#a6e22e">b</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">B</span>)   { <span style="color:#a6e22e">benchmarkGenerate</span>(<span style="color:#ae81ff">10000</span>, <span style="color:#a6e22e">b</span>) }
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">BenchmarkGenerate100000</span>(<span style="color:#a6e22e">b</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">B</span>)  { <span style="color:#a6e22e">benchmarkGenerate</span>(<span style="color:#ae81ff">100000</span>, <span style="color:#a6e22e">b</span>) }
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">BenchmarkGenerate1000000</span>(<span style="color:#a6e22e">b</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">B</span>) { <span style="color:#a6e22e">benchmarkGenerate</span>(<span style="color:#ae81ff">1000000</span>, <span style="color:#a6e22e">b</span>) }
</code></pre></div><p>这里，我们实现一个辅助函数 <code>benchmarkGenerate</code> 允许传入参数 i，并构造了 4 个不同输入的 benchmark 用例。运行结果如下：</p>
<pre tabindex="0"><code>$ go test -bench .                                                       
goos: darwin
goarch: amd64
pkg: example
BenchmarkGenerate1000-8            34048             34643 ns/op
BenchmarkGenerate10000-8            4070            295642 ns/op
BenchmarkGenerate100000-8            403           3230415 ns/op
BenchmarkGenerate1000000-8            39          32083701 ns/op
PASS
ok      example 6.597s
</code></pre><p>通过测试结果可以发现，输入变为原来的 10 倍，函数每次调用的时长也差不多是原来的 10 倍，这说明复杂度是线性的。</p>
<h3 id="resettimer"><strong>ResetTimer</strong><a hidden class="anchor" aria-hidden="true" href="#resettimer">#</a></h3>
<p>如果在 benchmark 开始前，需要一些准备工作，如果准备工作比较耗时，则需要将这部分代码的耗时忽略掉。比如下面的例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">BenchmarkFib</span>(<span style="color:#a6e22e">b</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">B</span>) {
	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">3</span>) <span style="color:#75715e">// 模拟耗时准备任务
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">n</span> &lt; <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">N</span>; <span style="color:#a6e22e">n</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">fib</span>(<span style="color:#ae81ff">30</span>) <span style="color:#75715e">// run fib(30) b.N times
</span><span style="color:#75715e"></span>	}
}

</code></pre></div><p>运行结果是：</p>
<pre tabindex="0"><code>$ go test -bench='Fib$' -benchtime=50x .
goos: darwin
goarch: amd64
pkg: example
BenchmarkFib-8                50          65912552 ns/op
PASS
ok      example 6.319s

</code></pre><p>50次调用，每次调用约 0.66s，是之前的 0.06s 的 11 倍。究其原因，受到了耗时准备任务的干扰。我们需要用 <code>ResetTimer</code> 屏蔽掉：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">BenchmarkFib</span>(<span style="color:#a6e22e">b</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">B</span>) {
	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">3</span>) <span style="color:#75715e">// 模拟耗时准备任务
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">ResetTimer</span>() <span style="color:#75715e">// 重置定时器
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">n</span> &lt; <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">N</span>; <span style="color:#a6e22e">n</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">fib</span>(<span style="color:#ae81ff">30</span>) <span style="color:#75715e">// run fib(30) b.N times
</span><span style="color:#75715e"></span>	}
}

</code></pre></div><pre tabindex="0"><code>$ go test -bench='Fib$' -benchtime=50x .
goos: darwin
goarch: amd64
pkg: example
BenchmarkFib-8                50           6187485 ns/op
PASS
ok      example 6.330s
</code></pre><h3 id="stoptimer--starttimer"><strong>StopTimer &amp; StartTimer</strong><a hidden class="anchor" aria-hidden="true" href="#stoptimer--starttimer">#</a></h3>
<p>还有一种情况，每次函数调用前后需要一些准备工作和清理工作，我们可以使用 <code>StopTimer</code> 暂停计时以及使用 <code>StartTimer</code> 开始计时。</p>
<p>例如，如果测试一个冒泡函数的性能，每次调用冒泡函数前，需要随机生成一个数字序列，这是非常耗时的操作，这种场景下，就需要使用 <code>StopTimer</code> 和 <code>StartTimer</code> 避免将这部分时间计算在内。</p>
<p>例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// sort_test.go
</span><span style="color:#75715e"></span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;math/rand&#34;</span>
	<span style="color:#e6db74">&#34;testing&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">generateWithCap</span>(<span style="color:#a6e22e">n</span> <span style="color:#66d9ef">int</span>) []<span style="color:#66d9ef">int</span> {
	<span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Seed</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">UnixNano</span>())
	<span style="color:#a6e22e">nums</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">int</span>, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">n</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">n</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">nums</span> = append(<span style="color:#a6e22e">nums</span>, <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Int</span>())
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">nums</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">bubbleSort</span>(<span style="color:#a6e22e">nums</span> []<span style="color:#66d9ef">int</span>) {
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; len(<span style="color:#a6e22e">nums</span>); <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">j</span> &lt; len(<span style="color:#a6e22e">nums</span>)<span style="color:#f92672">-</span><span style="color:#a6e22e">i</span>; <span style="color:#a6e22e">j</span><span style="color:#f92672">++</span> {
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">nums</span>[<span style="color:#a6e22e">j</span>] &lt; <span style="color:#a6e22e">nums</span>[<span style="color:#a6e22e">j</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] {
				<span style="color:#a6e22e">nums</span>[<span style="color:#a6e22e">j</span>], <span style="color:#a6e22e">nums</span>[<span style="color:#a6e22e">j</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] = <span style="color:#a6e22e">nums</span>[<span style="color:#a6e22e">j</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#a6e22e">nums</span>[<span style="color:#a6e22e">j</span>]
			}
		}
	}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">BenchmarkBubbleSort</span>(<span style="color:#a6e22e">b</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">B</span>) {
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">n</span> &lt; <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">N</span>; <span style="color:#a6e22e">n</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">StopTimer</span>()
		<span style="color:#a6e22e">nums</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">generateWithCap</span>(<span style="color:#ae81ff">10000</span>)
		<span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">StartTimer</span>()
		<span style="color:#a6e22e">bubbleSort</span>(<span style="color:#a6e22e">nums</span>)
	}
}

</code></pre></div><p>执行该用例，每次排序耗时约 0.1s。</p>
<pre tabindex="0"><code>$ go test -bench='Sort$' .
goos: darwin
goarch: amd64
pkg: example
BenchmarkBubbleSort-8                  9         113280509 ns/op
PASS
ok      example 1.146s
</code></pre>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://nicko-ch.github.io/tags/go/">Go</a></li>
      <li><a href="https://nicko-ch.github.io/tags/golang/">Golang</a></li>
    </ul>
  </footer>
</article>
    </main>
    <footer class="footer">
    <span>&copy; 2023 <a href="https://nicko-ch.github.io/">&gt; $ cd /home</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>

<script>
    let menu = document.getElementById('menu')
    menu.scrollLeft = localStorage.getItem("menu-scroll-position");
    menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
